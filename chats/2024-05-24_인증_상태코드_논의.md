# 2024-05-24 MCP 인증 상태 코드 논의 요약

## 주요 내용

### 1. 초기 상태 코드 적용
- HTTP 상태 코드 중 "미래 구현 예정"을 의미하는 코드로 `501 Not Implemented`를 확인했습니다.
- overlay-mcp 프로젝트에서 MCP 프로토콜 버전 `V20250326` 관련 핸들러(`handle_get`, `handle_post`, `handle_delete`)가 `501`을 반환하도록 코드를 수정했습니다.

### 2. 핵심 논의: `mcp-authorization` 규칙과 상태 코드 (401 vs 403)
- **규칙 검토:**
    - `401 Unauthorized`: 인증 필요 또는 토큰/키 유효하지 않음.
    - `403 Forbidden`: 인증 성공 후 권한 부족.
- **현재 코드 분석 (`CheckAuthorizer` in `src/authorizer/mod.rs`):**
    - 현재 로직은 자격 증명(JWT/API 키)의 **존재 여부**만으로 응답 상태 코드(`401` 또는 `403`)를 *사전에* 결정합니다.
    - 이로 인해, 자격 증명이 존재하지만 서버에서 **유효하지 않다고 판단되는 경우** (규칙상 `401` 반환 필요)에도 `403` 코드가 반환될 수 있는 문제가 식별되었습니다.
- **JWT 처리:**
    - `src/middleware/jwt_extractor.rs`는 유효하지 않은 JWT(서명 오류, 만료 등)에 대해 올바르게 `401`을 반환합니다.
    - 문제는 `CheckAuthorizer`가 유효성 검사를 통과한 JWT를 처리하는 방식에 있습니다.
- **API 키 처리 심층 논의:**
    - **초기 의견:** 서버가 알지 못하는(Whitelist에 없는) API 키는 "유효하지 않은 자격 증명"이므로 `401` 반환이 적합합니다.
    - **사용자 모델 설명 및 근거:**
        - API 키는 별도의 형식 검증 없이 임의 문자열입니다.
        - 키 제공 자체가 "인증 시도"로 간주되며, 실제 접근 제어는 `whitelist`/`blacklist`를 통한 "인가" 단계에서 이루어집니다.
        - 따라서 접근 거부 시 **항상 `403 Forbidden` (권한 부족)을 반환하는 것이 모델에 부합**합니다.
        - **실용적 이유:**
            - MCP 표준에서 `401` 응답은 OAuth2 로그인 흐름을 유발할 수 있으므로, API 키 인증 실패 시 `401`을 사용하면 원치 않는 동작(사용자 로그인 시도)이 발생할 수 있습니다.
            - 모든 실패 케이스(미등록 키, `blacklist` 키)에 대해 일관되게 `403`을 반환하면, 응답 코드 차이를 통해 키의 유효성을 추측하려는 공격을 방지할 수 있습니다 (보안 강화).
    - **결론/합의:** 사용자 시스템의 API 키 모델, MCP 프로토콜 특성, 보안 고려 사항을 감안할 때, **API 키 인증 실패 시 `403`을 일관되게 사용하는 것이 실용적이고 타당한 접근 방식**으로 합의되었습니다.

### 3. 코드 리팩토링 시도 (보류)
- `AuthorizerResponse` enum을 `Allow`, `Deny`, `Unknown`으로 세분화하여 인증/인가 실패 원인을 명확히 구분하고, `CheckAuthorizer`가 이 정보를 바탕으로 최종 상태 코드(401 또는 403)를 결정하도록 수정하려 했습니다.
- `constant_authorizer.rs`의 `whitelist`/`blacklist` 함수를 단일 `check_auth` 함수로 통합하는 리팩토링을 진행했습니다.
- 변경 범위가 크고 추가 수정이 필요하여, 관련 코드 변경 적용은 일단 보류하기로 했습니다. 